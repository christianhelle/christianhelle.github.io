---
layout: post
title: Copying Files from the Device to the Desktop using .NET
date: '2007-06-16T17:38:00.001+02:00'
author: Christian Resma Helle
tags:
- RAPI
modified_time: '2010-08-23T12:42:18.173+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-9184502135880847787
blogger_orig_url: https://christian-helle.blogspot.com/2007/06/copying-files-from-device-to-desktop.html
---

Recently, I’ve been working on a tool that creates a backup of a SQL Server Compact Edition database on the device to the desktop. To accomplish this, I used the Remote API (RAPI). Unfortunately, the Remote API is not yet available in managed code. In this article I would like to demonstrate how to P/Invoke methods from the Remote API for copying files from the device to the desktop  using managed code.<br /><br />First, we’ll need some P/Invokes to <b>rapi.dll</b><br /><font face="Courier"><br />[<font color="#408080">DllImport</font>(<font color="Red">"rapi.dll"</font>)]<br /><font color="Blue">static extern int</font> CeRapiInit();<br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"rapi.dll"</font>)]<br /><font color="Blue">static extern int</font> CeRapiUninit();<br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"rapi.dll"</font>)]<br /><font color="Blue">static extern int</font> CeCloseHandle(<font color="#408080">IntPtr</font> hObject); <br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"rapi.dll"</font>, CharSet = <font color="#408080">CharSet</font>.Unicode)]<br /><font color="Blue">static extern</font> <font color="#408080">IntPtr</font> CeCreateFile(<br />&nbsp;&nbsp;<font color="Blue">string</font> lpFileName,<br />&nbsp;&nbsp;<font color="Blue">uint</font> dwDesiredAccess,<br />&nbsp;&nbsp;<font color="Blue">int</font> dwShareMode,<br />&nbsp;&nbsp;<font color="Blue">int</font> lpSecurityAttributes,<br />&nbsp;&nbsp;<font color="Blue">int</font> dwCreationDisposition,<br />&nbsp;&nbsp;<font color="Blue">int</font> dwFlagsAndAttributes,<br />&nbsp;&nbsp;<font color="Blue">int</font> hTemplateFile);<br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"rapi.dll"</font>, CharSet = <font color="#408080">CharSet</font>.Unicode)]<br /><font color="Blue">static extern int</font> CeReadFile(<br />&nbsp;&nbsp;<font color="#408080">IntPtr</font> hFile,<br />&nbsp;&nbsp;<font color="Blue">byte</font>[] lpBuffer,<br />&nbsp;&nbsp;<font color="Blue">int</font> nNumberOfbytesToRead,<br />&nbsp;&nbsp;<font color="Blue">ref int</font> lpNumberOfbytesRead,<br />&nbsp;&nbsp;<font color="Blue">int</font> lpOverlapped);<br /><br /><font color="Blue">const int</font> ERROR_SUCCESS = 0;<br /><font color="Blue">const int</font> OPEN_EXISTING = 3;<br /><font color="Blue">const int</font> INVALID_HANDLE_VALUE = -1;<br /><font color="Blue">const int</font> FILE_ATTRIBUTE_NORMAL = 0x80;<br /><font color="Blue">const uint</font> GENERIC_READ = 0x80000000;<br /></font><br /><br />Now let’s create a method called CopyFromDevice(string remote_file, string local_file). The remote_file parameter is the source file on the device that you wish to copy. The local_file parameter is the destination filename on the desktop. <br /><font face="Courier"><br /><font color="Blue">public static void</font> CopyFromDevice(<font color="Blue">string</font> remote_file, <font color="Blue">string</font> local_file)<br />{<br />&nbsp;&nbsp;<font color="Blue">bool</font> rapi = CeRapiInit() == ERROR_SUCCESS;<br />&nbsp;&nbsp;<font color="Blue">if</font> (!rapi) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font>;<br />&nbsp;&nbsp;}                       <br /><br />&nbsp;&nbsp;<font color="#408080">IntPtr</font> remote_file_ptr = CeCreateFile(<br />&nbsp;&nbsp;&nbsp;&nbsp;remote_file, <br />&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_READ, <br />&nbsp;&nbsp;&nbsp;&nbsp;0, <br />&nbsp;&nbsp;&nbsp;&nbsp;0, <br />&nbsp;&nbsp;&nbsp;&nbsp;OPEN_EXISTING, <br />&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL, <br />&nbsp;&nbsp;&nbsp;&nbsp;0);<br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (remote_file_ptr.ToInt32() == INVALID_HANDLE_VALUE) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font>;<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="#408080">FileStream</font> local_file_stream = <font color="Blue">new</font> <font color="#408080">FileStream</font>(<br />&nbsp;&nbsp;&nbsp;&nbsp;local_file, <br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#408080">FileMode</font>.Create, <br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#408080">FileAccess</font>.Write);<br /><br />&nbsp;&nbsp;<font color="Blue">int</font> read = 0;<br />&nbsp;&nbsp;<font color="Blue">int</font> size = 1024 * 4;<br />&nbsp;&nbsp;<font color="Blue">byte</font>[] data = <font color="Blue">new byte</font>[size];<br />      <br />&nbsp;&nbsp;CeReadFile(remote_file_ptr, data, size, ref read, 0);<br /><br />&nbsp;&nbsp;<font color="Blue">while</font> (read > 0) {<br />&nbsp;&nbsp;&nbsp;&nbsp;local_file_stream.Write(data, 0, read);<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">if</font> (CeReadFile(remote_file_ptr, data, size, ref read, 0) == 0) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CeCloseHandle(remote_file_ptr);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local_file_stream.Close();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font>;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;CeCloseHandle(remote_file_ptr);<br />&nbsp;&nbsp;local_file_stream.Flush();<br />&nbsp;&nbsp;local_file_stream.Close();           <br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (rapi) {<br />&nbsp;&nbsp;&nbsp;&nbsp;CeRapiUninit(); <br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (!<font color="#408080">File</font>.Exists(local_file)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">FileNotFoundException</font>(<font color="Red">"The file was not copied to the desktop"</font>);<br />&nbsp;&nbsp;}<br />}<br /></font><br />To use the code above you will have to know the full path of the file on the device. The way I did it was to read the registry on the device and check if my application was installed, if it was then I get the path of the application and pass as the path in my remote_file parameter.