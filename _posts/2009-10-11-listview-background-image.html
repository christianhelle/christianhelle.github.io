---
layout: post
title: ListView Background Image in .NETCF
date: '2009-10-11T22:00:00.006+02:00'
author: Christian Resma Helle
tags:
- Controls
- ListView
- Windows Mobile
- ".NET Compact Framework"
modified_time: '2009-10-12T16:35:50.803+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-138828835341635689
blogger_orig_url: https://christian-helle.blogspot.com/2009/10/listview-background-image.html
---

In this short entry I'd like to demonstrate how to display a background image in the ListView control. For this we will send the <a href="http://msdn.microsoft.com/en-us/library/aa453514.aspx">LVM_SETBKIMAGE</a> or the <a href="http://msdn.microsoft.com/en-us/library/aa453498.aspx">LVM_GETBKIMAGE</a> message to the ListView control with the <a href="http://msdn.microsoft.com/en-us/library/aa453422.aspx">LVBKIMAGE</a> struct as the LPARAM. Unfortunately, the Windows CE version of LVBKIMAGE does not support LVBKIF_SOURCE_URL flag which allows using an image file on the file system for the background image of the ListView. <br /><br />The layout of the background image can be either tiled or specified by an offset percentage. The background image is not affected by custom drawing, unless of course you decide to fill each sub item rectangle. For setting the background image we use the LVBKIF_SOURCE_HBITMAP flag together with the layout which is either LVBKIF_STYLE_TILE or LVBKIF_STYLE_NORMAL. If we set the layout to LVBKIF_STYLE_NORMAL, then we have the option of setting where the image will be drawn by setting the value of xOffsetPercentage and yOffsetPercentage.<br /><br />In this example I'd like to make use of extension methods to add the SetBackgroundImage() and GetBackgroundImage() methods to ListView. This can of course be easily used to in a property to an inherited ListView.<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: blue;">class</span> <span style="color: #2b91af;">ListViewExtensions</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll&quot;</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> SendMessage(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">int</span> Msg, <span style="color: blue;">int</span> wParam, <span style="color: blue;">ref</span> <span style="color: #2b91af;">LVBKIMAGE</span> lParam);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVM_FIRST = 0x1000;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVM_SETBKIMAGE = (LVM_FIRST + 138);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVM_GETBKIMAGE = (LVM_FIRST + 139);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVBKIF_SOURCE_NONE = 0x00000000;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVBKIF_SOURCE_HBITMAP = 0x00000001;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVBKIF_STYLE_TILE = 0x00000010;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVBKIF_STYLE_NORMAL = 0x00000000;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> <span style="color: #2b91af;">LVBKIMAGE</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> ulFlags;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> hbm;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> pszImage; <span style="color: green;">// not supported</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> cchImageMax;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> xOffsetPercent;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> yOffsetPercent;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: blue;">void</span> SetBackgroundImage(<span style="color: blue;">this</span> <span style="color: #2b91af;">ListView</span> listView, <span style="color: #2b91af;">Bitmap</span> bitmap)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SetBackgroundImage(listView, bitmap, <span style="color: blue;">false</span>);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: blue;">void</span> SetBackgroundImage(<span style="color: blue;">this</span> <span style="color: #2b91af;">ListView</span> listView, <span style="color: #2b91af;">Bitmap</span> bitmap, <span style="color: blue;">bool</span> tileLayout)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SetBackgroundImage(listView, bitmap, tileLayout, 0, 0);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: blue;">void</span> SetBackgroundImage(</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">this</span> <span style="color: #2b91af;">ListView</span> listView,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Bitmap</span> bitmap,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">bool</span> tileLayout,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> xOffsetPercent,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> yOffsetPercent)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">LVBKIMAGE</span> lvBkImage = <span style="color: blue;">new</span> <span style="color: #2b91af;">LVBKIMAGE</span>();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (bitmap == <span style="color: blue;">null</span>)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.ulFlags = LVBKIF_SOURCE_NONE;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.ulFlags = LVBKIF_SOURCE_HBITMAP | (tileLayout ? LVBKIF_STYLE_TILE : LVBKIF_STYLE_NORMAL);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.hbm = bitmap.GetHbitmap();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.xOffsetPercent = xOffsetPercent;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.yOffsetPercent = yOffsetPercent;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SendMessage(listView.Handle, LVM_SETBKIMAGE, 0, <span style="color: blue;">ref</span> lvBkImage);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: #2b91af;">Bitmap</span> GetBackgroundImage(<span style="color: blue;">this</span> <span style="color: #2b91af;">ListView</span> listView)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">LVBKIMAGE</span> lvBkImage = <span style="color: blue;">new</span> <span style="color: #2b91af;">LVBKIMAGE</span>();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lvBkImage.ulFlags = LVBKIF_SOURCE_HBITMAP;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SendMessage(listView.Handle, LVM_GETBKIMAGE, 0, <span style="color: blue;">ref</span> lvBkImage);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (lvBkImage.hbm == <span style="color: #2b91af;">IntPtr</span>.Zero)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">null</span>;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: #2b91af;">Bitmap</span>.FromHbitmap(lvBkImage.hbm);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br />Here's an example of exposing the background image as a property in an inherited ListView by using the extension methods above.<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">class</span> <span style="color: #2b91af;">ListViewEx</span> : <span style="color: #2b91af;">ListView</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">Bitmap</span> BackgroundImage</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">get</span> { <span style="color: blue;">return</span> <span style="color: blue;">this</span>.GetBackgroundImage(); }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">set</span> { <span style="color: blue;">this</span>.SetBackgroundImage(<span style="color: blue;">value</span>, BackgroundLayout == <span style="color: #2b91af;">BackgroundImageLayout</span>.Tile); }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">BackgroundImageLayout</span> BackgroundLayout { <span style="color: blue;">get</span>; <span style="color: blue;">set</span>; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">enum</span> <span style="color: #2b91af;">BackgroundImageLayout</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Tile,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Center</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br />A small catch with the ListView background image is that it is only supported in Windows CE 5.0 and later. Hope you found this information useful.