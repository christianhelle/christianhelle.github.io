---
layout: post
title: How to toggle the Wi-fi radio
date: '2010-01-20T13:01:00.036+01:00'
# author: Christian Resma Helle
tags:
- Native Code
- How to
- Windows Mobile
- ".NET Compact Framework"
modified_time: '2010-01-20T14:22:23.637+01:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-9155466612543890030
blogger_orig_url: https://christian-helle.blogspot.com/2010/01/how-to-toggle-wi-fi-radio.html
---

I had a task to complete today where I was to create an application to toggle the Wi-Fi radio. I had two major requirements for this task; I was supposed to not spend more an hour on this and it must run on older devices running Pocket PC 2003 (or older)<br /><br />This is what I came up with, 1 function (the entry point) and it uses only 3 power management API calls; <a href="http://msdn.microsoft.com/en-us/library/ms889220.aspx">GetDevicePower</a>, <a href="http://msdn.microsoft.com/en-us/library/ms896927.aspx">DevicePowerNotify</a>, and <a href="http://msdn.microsoft.com/en-us/library/ms889493.aspx">SetDevicePower</a><br /><br />Basically I spent most of the time finding the device name for the wireless device. It seems to be pretty used for Intermec devices as I tested it on 3 different devices (or it could also be that only those 3 devices used the same device name)<br /><br />Anyway, here's the code (works only for Intermec devices):<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">#include</span> <span style="color: #a31515;">&lt;windows.h&gt;</span></pre><pre style="margin: 0px;"><span style="color: blue;">#include</span> <span style="color: #a31515;">&lt;pm.h&gt;</span></pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">#define</span> INTERMEC_WIFI_DEVICE&nbsp;&nbsp;&nbsp; L<span style="color: #a31515;">&quot;{98C5250D-C29A-4985-AE5F-AFE5367E5006}\\BCMCF1&quot;</span></pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">int</span> _tmain(<span style="color: blue;">int</span> argc, _TCHAR* argv[])</pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; CEDEVICE_POWER_STATE state;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; GetDevicePower(INTERMEC_WIFI_DEVICE, POWER_NAME, &amp;state);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; CEDEVICE_POWER_STATE newState = (state == D0) ? D4 : D0;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; DevicePowerNotify(INTERMEC_WIFI_DEVICE, newState, POWER_NAME);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; SetDevicePower(INTERMEC_WIFI_DEVICE, POWER_NAME, newState);</pre><pre style="margin: 0px;">}</pre></div><br /><br />Normally when I experiment with the platform SDK, I just create native console applications and test how the function works. Since my application was simple and didn't need a UI, I just shipped it in native code.<br /><br />But for the sake of sharing knowledge I ported my tiny application to the .NET Compact Framework. Here's the code (works only for Intermec devices):<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>, SetLastError = <span style="color: blue;">true</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> DevicePowerNotify(<span style="color: blue;">string</span> name, <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> state, <span style="color: blue;">int</span> flags);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>, SetLastError = <span style="color: blue;">true</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> SetDevicePower(<span style="color: blue;">string</span> pvDevice, <span style="color: blue;">int</span> dwDeviceFlags, <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> DeviceState);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>, SetLastError = <span style="color: blue;">true</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> GetDevicePower(<span style="color: blue;">string</span> pvDevice, <span style="color: blue;">int</span> dwDeviceFlags, <span style="color: blue;">ref</span> <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> pDeviceState);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">enum</span> <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> : <span style="color: blue;">int</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; PwrDeviceUnspecified = -1,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; D0 = 0,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; D1 = 1,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; D2 = 2,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; D3 = 3,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; D4 = 4,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; PwrDeviceMaximum = 5</pre><pre style="margin: 0px;">}</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> POWER_NAME = 0x00000001;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">string</span> ADAPTER_NAME = <span style="color: #a31515;">&quot;{98C5250D-C29A-4985-AE5F-AFE5367E5006}\\BCMCF1&quot;</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">void</span> Main()</pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> state = <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span>.PwrDeviceUnspecified;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; GetDevicePower(ADAPTER_NAME, POWER_NAME, <span style="color: blue;">ref</span> state);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span> newState = (state == <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span>.D0)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ? <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span>.D4</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; : <span style="color: #2b91af;">CEDEVICE_POWER_STATE</span>.D0;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; DevicePowerNotify(ADAPTER_NAME, newState, POWER_NAME);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; SetDevicePower(ADAPTER_NAME, POWER_NAME, newState);</pre><pre style="margin: 0px;">}</pre></div><br /><br />There are smarter, better, and non-OEM specific ways to do this, both in native and managed code. In native code, one can use the wireless device functions (GetWirelessDevice, ChangeRadioState, FreeDeviceList) in ossvcs.dll as described in <a href="http://www.teksoftco.com/articles/article%20007/radiodevices.htm">this</a> article. And in managed code, one can take advantage of the <a href="http://www.opennetcf.com/sdf">OpenNETCF Smart Device Framework</a>.<br /><br />Here's an example of how to use the OpenNETCF.WindowsMobile namespace in the Smart Device Framework for toggling the state of wireless devices:<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">using</span> System.Linq;</pre><pre style="margin: 0px;"><span style="color: blue;">using</span> OpenNETCF.WindowsMobile;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">class</span> <span style="color: #2b91af;">Program</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> Main()</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> wifi = <span style="color: blue;">from</span> radio <span style="color: blue;">in</span> <span style="color: #2b91af;">Radios</span>.GetRadios()</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: blue;">where</span> radio.RadioType == <span style="color: #2b91af;">RadioType</span>.WiFi</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: blue;">select</span> radio;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">foreach</span> (<span style="color: blue;">var</span> radio <span style="color: blue;">in</span> wifi)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; radio.RadioState = (radio.RadioState == <span style="color: #2b91af;">RadioState</span>.On) ? <span style="color: #2b91af;">RadioState</span>.On : <span style="color: #2b91af;">RadioState</span>.Off;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br /><br />I hope you found this article useful