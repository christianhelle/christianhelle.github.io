---
layout: post
title: Integrating with TomTom Navigator
date: '2007-06-07T19:53:00.000+02:00'
# author: Christian Resma Helle
tags:
- GPS
- Windows Mobile
- ".NET Compact Framework"
modified_time: '2008-02-07T23:15:11.886+01:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-6470922594105492551
blogger_orig_url: https://christian-helle.blogspot.com/2007/06/integrating-with-tomtom-navigator.html
---

PDA's are used for pretty much everything these days. From the bunch of devices the I work (play) with, I took a great liking to devices that have built in GPS receivers. These devices are usually bundled with really cool navigation software from various vendors. Some of these navigation software have SDK's that you can buy separately. By using these SDK's, you can fully integrate navigation features to your mobile solutions.<br /><br />In this article, I would like to discuss how to integrate a .NET Compact Framework application with TomTom Navigator. I will also demonstrate an example of making a generic navigator wrapper so your application is not just bound to one kind of navigation software.<br /><br />Before we get started, we need to have the TomTom Navigator SDK. Unfortunately this is not free, but can be easily purchased from the <a href="http://www.tomtom.com/pro/">TomTom Pro website</a>.<br /><br />Before we dig into more detail, let's go through our software requirements. We need the following:<br /><br />&nbsp; &nbsp; 1. Visual Studio 2005<br />&nbsp; &nbsp; 2. Windows Mobile 5.0 SDK for Pocket PC<br />&nbsp; &nbsp; 3. A device running Windows Mobile 5.0 with TomTom Navigator 5 installed<br />&nbsp; &nbsp; 4. The TomTom Navigator SDK<br />&nbsp; &nbsp; 5. ActiveSync 4.2 or higher (for Vista, the Mobile Device Center)<br /><br /><br />Now, Lets get started...<br /><br /><br />Here is what we need to make:<br /><br />&nbsp; &nbsp; 1. native wrapper for the TomTom SDK (native dll)<br />&nbsp; &nbsp; 2. generic navigator wrapper in .NET CF<br />&nbsp; &nbsp; 3. managed TomTom wrapper<br />&nbsp; &nbsp; 4. device application that will call TomTom SDK wrapper methods<br /><br />Sounds pretty simple doesn't it?<br /><br /><br /><b>1. Native Wrapper for the TomTom SDK</b><br /><br />We will first need a little help from native code to access the TomTom SDK. We cannot access the TomTom SDK directly from .NET due to the architecture of the SDK. We have to wrap around the TomTom SDK C++ classes and methods and expose them as C type functions. <br /><br />In your native wrapper, lets say we want to wrap the following TomTom SDK functions:<br />&nbsp; - GetApplicationVersion(TError* err, TVersion* ver)<br />&nbsp; - FlashMessage(TError* err, char* msg, int ms)<br />&nbsp; - NavigateToAddress(TError* aError, char* aCity, char* aStreet, char* aHouseNr, char* aPostcode)<br /><br /><br />[C++ CODE]<br /><font face="Courier" size=2><br /><font color="Blue">#include</font> <font color="Red">"sdkconstants.h"</font><br /><font color="Blue">#include</font> <font color="Red">"TomTomAPI.h"</font><br /><font color="Blue">#include</font> <font color="Red">"TomTomGoFileLayer.h"</font><br /><br /><font color="Blue">#define</font> CLIENT_NAME <font color="Red">"client"</font><br /><br />CTomTomAPI::TError err;<br /><font color="Blue">int</font> res = 0; <br /><br />BOOL APIENTRY DllMain( <br />&nbsp;&nbsp;HANDLE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved )<br />{<br />&nbsp;&nbsp;<font color="Blue">switch</font> (ul_reason_for_call)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;<font color="Blue">case</font> DLL_PROCESS_ATTACH:<br />&nbsp;&nbsp;<font color="Blue">case</font> DLL_THREAD_ATTACH:<br />&nbsp;&nbsp;<font color="Blue">case</font> DLL_THREAD_DETACH:<br />&nbsp;&nbsp;<font color="Blue">case</font> DLL_PROCESS_DETACH:<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">break</font>;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;<font color="Blue">return</font> TRUE;<br />} <br /><br /><font color="Blue">extern</font> <font color="Red">"C"</font> <font color="Blue">__declspec(dllexport) int</font> TTN_GetApplicationVersion(<br />&nbsp;&nbsp;<font color="Blue">int</font>* iError, LPTSTR szVersion, <font color="Blue">int</font> *iBuildNumber )<br />{<br />&nbsp;&nbsp;MTomTomCommunicationLayerInterface *comms =<br />&nbsp;&nbsp;&nbsp;&nbsp;DEFAULT_TRANSPORTATION_LAYER(CLIENT_NAME,2005,TOMTOM_TCPIP_PORT);<br /><br />&nbsp;&nbsp;CTomTomAPI api(*comms);<br />&nbsp;&nbsp;CTomTomAPI::TVersion version;<br />&nbsp;&nbsp;res = api.GetApplicationVersion(&err, &version);<br />&nbsp;&nbsp;*iError = err.iError;<br /><br />&nbsp;&nbsp;TCHAR str[16];<br />&nbsp;&nbsp;_stprintf(str, TEXT(<font color="Red">"%S"</font>), version.iVersion);<br />&nbsp;&nbsp;lstrcpy( szVersion, (LPTSTR)str );<br />&nbsp;&nbsp;*iBuildNumber = version.iBuildNumber;<br /><br />&nbsp;&nbsp;<font color="Blue">delete</font> comms;<br />&nbsp;&nbsp;<font color="Blue">return</font> res;<br />} <br /><br /><font color="Blue">extern</font> <font color="Red">"C"</font> <font color="Blue">__declspec(dllexport) int</font> TTN_FlashMessage(<br />&nbsp;&nbsp; <font color="Blue">int</font>* iError, <font color="Blue">char</font>* aMessage, <font color="Blue">int</font> aMilliSeconds )<br />{<br />&nbsp;&nbsp;<font color="Blue">char</font> message[256];<br />&nbsp;&nbsp;sprintf(message, <font color="Red">"%S"</font>, aMessage);<br /><br />&nbsp;&nbsp;MTomTomCommunicationLayerInterface *comms =<br />&nbsp;&nbsp;&nbsp;&nbsp;DEFAULT_TRANSPORTATION_LAYER(CLIENT_NAME,2005,TOMTOM_TCPIP_PORT);<br /><br />&nbsp;&nbsp;CTomTomAPI api(*comms);<br />&nbsp;&nbsp;res = api.FlashMessage(&err, message, aMilliSeconds);<br />&nbsp;&nbsp;*iError = err.iError;<br /><br />&nbsp;&nbsp;<font color="Blue">delete</font> comms;<br />&nbsp;&nbsp;<font color="Blue">return</font> res;<br />} <br /><br /><font color="Blue">extern</font> <font color="Red">"C"</font> <font color="Blue">__declspec(dllexport) int</font> TTN_NavigateToAddress(<br />&nbsp;&nbsp; <font color="Blue">int</font>* iError, <font color="Blue">char</font>* aCity, <font color="Blue">char</font>* aStreet, <font color="Blue">char</font>* aHouseNr, <font color="Blue">char</font>* aPostcode )<br />{<br />&nbsp;&nbsp;<font color="Blue">char</font> city[256];<br />&nbsp;&nbsp;<font color="Blue">char</font> street[256];<br />&nbsp;&nbsp;<font color="Blue">char</font> houseNr[16];<br />&nbsp;&nbsp;<font color="Blue">char</font> postcode[32];<br /> <br />&nbsp;&nbsp;sprintf(city, <font color="Red">"%S"</font>, aCity);<br />&nbsp;&nbsp;sprintf(street, <font color="Red">"%S"</font>, aStreet);<br />&nbsp;&nbsp;sprintf(houseNr, <font color="Red">"%S"</font>, aHouseNr);<br />&nbsp;&nbsp;sprintf(postcode, <font color="Red">"%S"</font>, aPostcode);<br /> <br />&nbsp;&nbsp;MTomTomCommunicationLayerInterface *comms =<br />&nbsp;&nbsp;&nbsp;&nbsp;DEFAULT_TRANSPORTATION_LAYER(CLIENT_NAME,2005,TOMTOM_TCPIP_PORT);<br /> <br />&nbsp;&nbsp;CTomTomAPI api(*comms);<br />&nbsp;&nbsp;res = api.NavigateToAddress(&err, city, street, houseNr, postcode);<br />&nbsp;&nbsp;*iError = err.iError;<br /> <br />&nbsp;&nbsp;<font color="Blue">delete</font> comms;<br />&nbsp;&nbsp;<font color="Blue">return</font> res;<br />}<br /></font><br />Let's set the output of the project to be called <b>TTSDK.dll</b><br /><br /><b>2. Generic Navigator Wrapper in .NET CF</b><br /><br />Once we've gotten our native wrapper up and running, we create a generic navigator wrapper. We start off by creating a smart device class library project. Once the project is created, add the following classes: INavigator.cs, Navigator.cs, and Common.cs<br /><br />Lets go and define the common objects we want to use in Common.cs<br /><br />[C# CODE]<br /><font face="Courier" size=2><br /><font color="Blue">public struct</font> <font color="#408080">NVersion</font> {<br />&nbsp;&nbsp;<font color="Blue">string</font> Version;<br />&nbsp;&nbsp;<font color="Blue">int</font> BuildNumber;<br />}<br /></font><br />INavigator.cs will be an interface defining the how the wrapper will look like. Lets add methods for the 3 TomTom SDK methods we want to use.<br /><br />[C# CODE]<br /><font face="Courier" size=2><br /><font color="Blue">public interface</font> <font color="#408080">INavigator</font><br />{<br />&nbsp;&nbsp;<font color="#408080">NVersion</font> GetApplicationVersion();<br />&nbsp;&nbsp;<font color="Blue">void</font> FlashMessage(<font color="Blue">string</font> text, <font color="Blue">int</font> duration);<br />&nbsp;&nbsp;<font color="Blue">void</font> NavigateToAddress(<font color="Blue">string</font> city, <font color="Blue">string</font> street, <font color="Blue">string</font> houseno, <font color="Blue">string</font> zipcode);<br />}<br /></font><br />Navigator.cs will be the class your application will call. This will load the managed TomTom wrapper as an instance of INavigator. Navigator itself will implement INavigator and will return calls from the TomTom wrapper.<br /><br />[C# CODE]<br /><font face="Courier" size=2><br /><font color="Blue">public class</font> <font color="#408080">Navigator</font> : <font color="#408080">INavigator</font><br />{<br />&nbsp;&nbsp;<font color="Blue">private</font> <font color="#408080">INavigator</font> instance;<br /><br />&nbsp;&nbsp;<font color="Blue">public</font> Navigator(<font color="Blue">string</font> typeName)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="#408080">Type</font> type = <font color="#408080">Type</font>.GetType(typeName);<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">if</font> (type == <font color="Blue">null</font>) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">TypeLoadException</font>();<br />&nbsp;&nbsp;&nbsp;&nbsp;} else {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instance = (<font color="#408080">INavigator</font>)<font color="#408080">Activator</font>.CreateInstance(type);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">if</font> (instance == <font color="Blue">null</font>) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">TypeLoadException</font>();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">public</font> <font color="#408080">TVersion</font> GetApplicationVersion()<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font> instance.GetApplicationVersion();<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">public void</font> FlashMessage(<font color="Blue">string</font> text, <font color="Blue">int</font> duration)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;instance.FlashMessage(text, duration);<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">public void</font> NavigateToAddress(<font color="Blue">string</font> city, <font color="Blue">string</font> street, <font color="Blue">string</font> houseno, <font color="Blue">string</font> zipcode)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;instance.NavigateToAddress(city, street, houseno, zipcode);<br />&nbsp;&nbsp;}<br />}<br /></font><br />The default constructor for Navigator accepts a type name. The format for type name is "[Namespace].[ClassName], [AssemblyName]"<br /><br /><b>3. Managed TomTom Wrapper</b><br /><br />Here we create a new smart device class library. Once the project is created, add a reference to the generic navigator wrapper since we will implement the INavigator interface and add a class called TomTom.cs<br /><br />Lets implement TomTom.cs as INavigator<br /><br />[C# CODE]<br /><font face="Courier" size=2><br />[<font color="#408080">DllImport</font>(<font color="Red">"TTSDK.dll"</font>, EntryPoint=<font color="Red">"TTN_GetApplicationVersion"</font>)]<br /><font color="Blue">internal static extern int</font> TTN_GetApplicationVersion(<br />&nbsp;&nbsp;<font color="Blue">ref int</font> iError, <font color="#408080">StringBuilder</font> szVersion, <font color="Blue">ref int</font> iBuildNumber);<br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"TTSDK.dll"</font>, EntryPoint=<font color="Red">"TTN_FlashMessage"</font>)]<br /><font color="Blue">internal static extern int</font> TTN_FlashMessage(<br />&nbsp;&nbsp;<font color="Blue">ref int</font> iError, <font color="Blue">string</font> aMessage, <font color="Blue">int</font> aMilliseconds);<br /><br />[<font color="#408080">DllImport</font>(<font color="Red">"TTSDK.dll"</font>, EntryPoint=<font color="Red">"TTN_NavigateToAddress"</font>)]<br /><font color="Blue">internal static extern int</font> TTN_NavigateToAddress(<br />&nbsp;&nbsp;<font color="Blue">ref int</font> iError, <font color="Blue">string</font> aCity, <font color="Blue">string</font> aStreet, <font color="Blue">string</font> aHouseNo, <font color="Blue">string</font> aPostcode);<br /><br /><font color="Blue">public void</font> FlashMessage(<font color="Blue">string</font> aMessage, <font color="Blue">int</font> aMilliseconds)<br />{<br />&nbsp;&nbsp;<font color="Blue">if</font> (0 != TTN_FlashMessage(<font color="Blue">ref</font> iError, aMessage, aMilliseconds)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">InvalidOperationException</font>();<br />&nbsp;&nbsp;}<br />}<br /><br /><font color="Blue">public</font> <font color="#408080">NVersion</font> GetApplicationVersion()<br />{<br />&nbsp;&nbsp;<font color="#408080">NVersion</font> version = <font color="Blue">new</font> <font color="#408080">TVersion</font>();<br />&nbsp;&nbsp;<font color="#408080">StringBuilder</font> szVersion = <font color="Blue">new</font> <font color="#408080">StringBuilder</font>();<br />&nbsp;&nbsp;<font color="Blue">int</font> iBuildNumber = 0;<br />&nbsp;&nbsp;<font color="Blue">int</font> iError = 0;<br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (0 != TTN_GetApplicationVersion(<font color="Blue">ref</font> iError, szVersion, <font color="Blue">ref</font> iBuildNumber)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">InvalidOperationException</font>();<br />&nbsp;&nbsp;} <font color="Blue">else</font> {<br />&nbsp;&nbsp;&nbsp;&nbsp;version.iVersion = szVersion.ToString();<br />&nbsp;&nbsp;&nbsp;&nbsp;version.iBuildNumber = iBuildNumber;<br />&nbsp;&nbsp;}<br />}<br /><br /><font color="Blue">public void</font> NavigateToAddress(<font color="Blue">string</font> sCity, <font color="Blue">string</font> sStreet, <font color="Blue">string</font> sHouseNo, <font color="Blue">string</font> sPostcode)<br />{<br />&nbsp;&nbsp;<font color="Blue">int</font> iError = 0;<br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (0 != TTN_NavigateToAddress(<font color="Blue">ref</font> iError, sCity, sStreet, sHouseNo, sPostcode)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">throw new</font> <font color="#408080">InvalidOperationException</font>();<br />&nbsp;&nbsp;}<br />}<br /></font><br />Now our TomTom wrapper is pretty much ready<br /><br /><b>4. Device Application</b><br /><br />In our application, we want to integrate with TomTom Navigator for navigating to a specific address. The address can could be retrieved from a web service, or stored in your pocket outlook. For this article, we're going to retrieve address information of a customer from Pocket Outlook.<br /><br />In order to do this, we will need the Windows Mobile 5.0 SDK for Pocket PC to be installed. Let's start off by creating a Windows Mobile 5.0 device application project. Once the project is created, add a reference to the Navigator wrapper and the TomTom wrapper. Next we have to build the Native wrapper project, and add the output file TTSDK.dll to our project. Set TTSDK.dll to be "Copied if Newer". To retrieve address information from contacts, we must add a reference to Microsoft.WindowsMobile.PocketOutlook.dll.<br /><br />Once the references and files are in place, we can start adding some code to Form1.cs. No need to change the name of the main form since this is only a small demo. We need to have a control that can contain the contacts, lets use the ComboBox control for now. Add a ComboBox control to the form and call it <i>cbContacts</i>. Lets add a "Navigate to" button to the form as well and call it <i>btnNavigate</i>.<br /><br />To retrieve a list of contacts we need to create a global instance of Microsoft.WindowsMobile.PocketOutlook.OutlookSession and Microsoft.WindowsMobile.PocketOutlook.ContactsCollection, once we instantiate our OutlookSession, we can then retrieve a list of Contacts through OutlookSession.Contacts.Items.<br /><br />To communicate with TomTom, we create an instance of Navigator(). The default constructor for Navigator will need a typeName for loading the TomTom wrapper as INavigator. It would be a smart idea to store the typeName in a seperate file, text or xml would be perfect. Once again, we do this so that if we want our application to integrate with different navigation software, we don't have to re-write everything. In this demo, the typeName will just be a hard coded string constant.<br /><br />[C# CODE]<br /><font face="Courier" size=2><br /><font color="Blue">private</font> Microsoft.WindowsMobile.PocketOutlook.<font color="#408080">OutlookSession</font> session;<br /><font color="Blue">private</font> Microsoft.WindowsMobile.PocketOutlook.<font color="#408080">ContactsCollection</font> contacts;<br /><br /><font color="Blue">private const string</font> TYPENAME=<font color="Red">"[The namespace].[The class name], [The assembly name]"</font>;<br /><font color="Blue">private</font> <font color="#408080">Navigator</font> navigator;<br /><br /><font color="Blue">public</font> Form1()<br />{<br />&nbsp;&nbsp;InitializeComponent();<br /><br />&nbsp;&nbsp;btnNavigate.Click += <font color="Blue">new</font> <font color="#408080">EventHandler</font>(btnNavigate_Click);<br />&nbsp;&nbsp;Closing += <font color="Blue">new</font> <font color="#408080">CancelEventHandler</font>(Form1_Closing);<br /><br />&nbsp;&nbsp;navigator = <font color="Blue">new</font> <font color="#408080">Navigator</font>(TYPENAME);<br /><br />&nbsp;&nbsp;<font color="Blue">string</font> restriction = <font color="Red">"[BusinessAddressStreet] <> \" \" OR [HomeAddressStreet] <> \" \""</font>;<br />&nbsp;&nbsp;session = <font color="Blue">new</font> <font color="#408080">OutlookSession</font>();<br />&nbsp;&nbsp;contacts = session.Contacts.Items.Restrict(restriction);<br />&nbsp;&nbsp;cbContacts.DataSource = contacts;<br />}<br /><br /><font color="Blue">private void</font> Form1_Closing(<font color="Blue">object</font> sender, <font color="#408080">CancelEventArgs</font> e)<br />{<br />&nbsp;&nbsp;contacts.Dispose();<br />&nbsp;&nbsp;contacts = <font color="Blue">null</font>;<br /><br />&nbsp;&nbsp;session.Dispose();<br />&nbsp;&nbsp;session = <font color="Blue">null</font>;<br />}<br /><br /><font color="Blue">private void</font> btnNavigate_Click(<font color="Blue">object</font> sender, <font color="#408080">EventArgs</font> e)<br />{<br />&nbsp;&nbsp;<font color="#408080">Contact</font> contact = cbContacts.SelectedItem <font color="Blue">as</font> <font color="#408080">Contact</font>;<br />&nbsp;&nbsp;navigator.FlashMessage(<font color="Red">"Navigating..."</font>, 1500);<br />&nbsp;&nbsp;navigator.NavigateToAddress(contact.BusinessAddressCity,<br />&nbsp;&nbsp;&nbsp;&nbsp;contact.BusinessAddressStreet,<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Red">"PARSE THE HOUSE NUMBER..."</font>,<br />&nbsp;&nbsp;&nbsp;&nbsp;contact.BusinessAddressPostalCode);<br />}<br /></font><br />When the application launches, your pocket outlook contacts that have a valid address will be loaded into our ComboBox control. Let's select an item in the ComboBox. Once you click on the Navigate button it will launch TomTom Navigator and display the message "Navigating" for 1.5 seconds, after that it will start calculating the route from your current location to your destination (in this case, the selected contact).<br /><br />That wasn't too hard was it?