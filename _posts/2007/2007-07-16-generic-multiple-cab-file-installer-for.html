---
layout: post
title: Generic Multiple CAB File Installer for the Desktop
date: '2007-07-16T15:25:00.000+02:00'
# author: Christian Resma Helle
tags: 
modified_time: '2007-07-18T22:56:29.011+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-4732073177296268418
blogger_orig_url: https://christian-helle.blogspot.com/2007/07/generic-multiple-cab-file-installer-for.html
---

In this article I would like to share a nice and simple multiple CAB file installer application for the desktop that I have been using for a few years now. The tool can install up to 10 CAB files and is written in C and has less than a 100 lines of code. <br /><br />Before we get started with installing multiple CAB files with a generic installer, let's try to go through the process of installing a CAB file from the desktop.<br /><br />Installing a CAB file from the desktop to the mobile device is pretty simple. All you need to do is create a .INI file that defines the CAB files you wish to install and launch the Application Manager (CeAppMgr.exe) passing the .INI file (full path) as the arguments. Application Manager is included when installing ActiveSync or the Windows Mobile Device Center (Vista)<br /><br />An Application Manager .INI file contains information that registers an application with the Application Manager. The .INI file uses the following format:<br /><font face="Courier"><br />[CEAppManager]<br />Version      = 1.0<br />Component    = component_name<br /><br />[component_name]<br />Description  = descriptive_name<br />CabFiles     = cab_filename [,cab_filename]<br /></font><br />Here's an MSDN link for more details on <a href="http://msdn2.microsoft.com/en-us/library/ms889558.aspx">Creating an .ini File for the Application Manager<br /></a><br />Before launching the Application Manager, we should first make sure that it's installed. Once we know that then we get the location of the file. The easiest way to do this programmatically is to look into the registry key SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\CEAppMgr.exe. If this key doesn't exist, then the Application Manager is not installed.<br /><br />The next step is quite interesting yet very simple. In this installer application, I use a configuration file called <b>Setup.ini</b> which defines which CAB files I want to install. <b>Setup.ini</b> will look like this:<br /><font face="Courier"><br />[CabFiles]<br />CABFILE1 = MyApp1.ini<br />CABFILE2 = SQLCE.ini<br />CABFILE3 = NETCF.ini<br />CABFILE4 =<br />CABFILE5 =<br />CABFILE6 =<br />CABFILE7 =<br />CABFILE8 =<br />CABFILE9 =<br />CABFILE10 =<br /></font><br />You can easily modifiy the code to install more than 10 CAB files if you think it's appropriate. I used <font face="Courier">GetPrivateProfileString()</font> to read the values from my configuration file.<br /><br /><b>Setup.ini</b>, the .INI files, and the actual CAB files are required to be in the same directory as the generic installer.<br /><br />Ok, now we have Application Manager command-line arguments ready, we now just have to launch it. I used <font face="Courier">CreateProcess()</font> to launch the application manager and used <font face="Courier">WaitForSingleObject()</font> to wait for the process to end.<br /><br />Here's the full source code:<br /><br />[C CODE]<br /><font face="Courier"><br /><font color="Blue">#include</font> <font color="Red">"windows.h"</font><br /><font color="Blue">#include</font> <font color="Red">"tchar.h"</font><br /><br /><font color="Blue">#define</font> CE_APP_MGR TEXT(<font color="Red">"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\CEAppMgr.exe"</font>)<br /><br />LPTSTR GetParameters()<br />{ <br />&nbsp;&nbsp;TCHAR szParams[2048]; <br />&nbsp;&nbsp;szParams[0] = TCHAR(0);<br /><br />&nbsp;&nbsp;TCHAR szCurrDir[MAX_PATH];<br />&nbsp;&nbsp;GetCurrentDirectory(MAX_PATH, szCurrDir);<br /><br />&nbsp;&nbsp;<font color="Blue">for</font> (<font color="Blue">int</font> i = 1; i < 11; i++) {<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR buffer[16];<br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR szKey[16];<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;strcpy(szKey, TEXT(<font color="Red">"CABFILE"</font>));<br />&nbsp;&nbsp;&nbsp;&nbsp;itoa(i, buffer, 16);  <br />&nbsp;&nbsp;&nbsp;&nbsp;strcat(szKey, buffer);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR szSetupIni[MAX_PATH];<br />&nbsp;&nbsp;&nbsp;&nbsp;strcpy(szSetupIni, szCurrDir);<br />&nbsp;&nbsp;&nbsp;&nbsp;strcat(szSetupIni, TEXT(<font color="Red">"\\"</font>));<br />&nbsp;&nbsp;&nbsp;&nbsp;strcat(szSetupIni, TEXT(<font color="Red">"Setup.ini"</font>));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;TCHAR szCabFile[MAX_PATH];<br />&nbsp;&nbsp;&nbsp;&nbsp;::GetPrivateProfileString(TEXT(<font color="Red">"CabFiles"</font>), szKey, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(TCHAR*)<font color="Red">""</font>, szCabFile, <font color="Blue">sizeof</font>(szCabFile), szSetupIni);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">if</font> (0 != strcmp(szCabFile, (TCHAR*)<font color="Red">""</font>)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(szParams, TEXT(<font color="Red">" \""</font>));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(szParams, szCurrDir);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(szParams, TEXT(<font color="Red">"\\"</font>));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(szParams, szCabFile);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(szParams, TEXT(<font color="Red">" \""</font>));<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">return</font> szParams;<br />}<br /><br /><font color="Blue">int</font> APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <font color="Blue">int</font> nCmdShow)<br />{<br />&nbsp;&nbsp;HKEY hkey; <br />&nbsp;&nbsp;DWORD dwDataSize = MAX_PATH;<br />&nbsp;&nbsp;DWORD dwType = REG_SZ;<br />&nbsp;&nbsp;TCHAR szCEAppMgrPath[MAX_PATH];<br /><br />&nbsp;&nbsp;<font color="Blue">if</font>(ERROR_SUCCESS == RegOpenKeyEx(HKEY_LOCAL_MACHINE, CE_APP_MGR, 0, KEY_READ, &hkey)) {<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">if</font>(ERROR_SUCCESS != RegQueryValueEx(hkey, NULL, NULL, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&dwType, (PBYTE)szCEAppMgrPath, &dwDataSize)) <br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, TEXT(<font color="Red">"Unable to find Application Manager for Pocket PC Applications"</font>), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT(<font color="Red">"Error"</font>), MB_ICONEXCLAMATION | MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font> 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;} <font color="Blue">else</font> {<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, TEXT(<font color="Red">"Unable to find Application Manager for Pocket PC Applications"</font>), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT(<font color="Red">"Error"</font>), MB_ICONEXCLAMATION | MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font> 1;<br />&nbsp;&nbsp;}<br /><br /><br />&nbsp;&nbsp;RegCloseKey(hkey);  <br /><br />&nbsp;&nbsp;STARTUPINFO startup_info = {0}; <br />&nbsp;&nbsp;PROCESS_INFORMATION pi = {0};<br />&nbsp;&nbsp;startup_info.cb = <font color="Blue">sizeof</font>(startup_info);<br /><br />&nbsp;&nbsp;<font color="Blue">if</font> (CreateProcess(szCEAppMgrPath, GetParameters(), NULL,<br />&nbsp;&nbsp;&nbsp;&nbsp;NULL, FALSE, 0, NULL, NULL, &startup_info, &pi))<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObject(pi.hProcess, INFINITE);<br />&nbsp;&nbsp;} <font color="Blue">else</font> {<br />&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL, TEXT(<font color="Red">"Unable to Launch Application Manager for Pocket PC Applications"</font>), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT(<font color="Red">"Error"</font>), MB_ICONEXCLAMATION | MB_OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;<font color="Blue">return</font> 2;<br />&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;<font color="Blue">return</font> 0;<br />}<br /></font><br /><br />When deplying my applications in this manner, I like packaging them in a self-extracting zip file that is configured for software installation. I'm still holding to an old version of Winzip Self-Extractor to accomplish this task.<br /><br />Another reason I use <font face="Courier">WaitForSingleObject</font> is because a self-extracting zip installer file deletes the all the temporary files it has extracted once the installer process ends. This means that your .INI and CAB files will be deleted even before they get copied to the device.