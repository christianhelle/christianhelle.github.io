---
layout: post
title: Widcomm Bluetooth Pairing Prompt
date: '2010-10-20T12:58:00.017+02:00'
# author: Christian Resma Helle
tags:
- ".NET Compact Framework"
modified_time: '2010-10-20T13:22:22.073+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-7477684092160171285
blogger_orig_url: https://christian-helle.blogspot.com/2010/10/widcomm-bluetooth-pairing-prompt.html
---

Not so long ago I had a project that involved Bluetooth communication from a windows mobile device to some custom designed hardware. Everything went smoothly with only a few bumps during the scope of the project. When we had the applications on the field, certain users where running on devices that used the Widcomm Bluetooth Stack and that gave us a few headaches. For one, our system doesn't use any security features in bluetooth hence it doesn't not require pairing. Our security architecture is service based and checks for certain keys being passed back and forth to an online service. Very standard stuff. The problem we had with the devices running on a Widcomm Bluetooth stack was that the user was always prompted to pair even though the device did not require pairing. The application was not designed to handle user input aside from logging in/out and some diagnostic features. The application was designed to just run quietly in the background with the device tucked in the users pocket.<br /><br />Since quite a few devices use the Widcomm Bluetooth Stack I needed a quick fix/hack to avoid the user having to pick up the device and click "Yes" on the security prompt to communicate with the device. The fix had to be as simple as possible and had to run without disrupting the user. My not so clean solution was to create a small application that does nothing but check if the Widcomm security pairing prompt app was running and if so send a keystroke event to simulate the user clicking on "Yes".<br /><br />The Widcomm security prompt app main window uses the class name <span style="font-weight:bold;">Broadcom_BTWizard</span> with the window name <span style="font-weight:bold;">Bluetooth</span>. I check if this window exists and send the F1 keyboard event to simulate clicking on the left hardware button on the device<br /><br />Here's a code snippet in C#<br /><br /><div style="font-family: Courier New; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: #2b91af;">IntPtr</span> FindWindow(<span style="color: blue;">string</span> lpClassName, <span style="color: blue;">string</span> lpWindowName);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll&quot;</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">void</span> keybd_event(<span style="color: blue;">byte</span> bVk, <span style="color: blue;">byte</span> bScan, <span style="color: blue;">int</span> dwFlags, <span style="color: blue;">int</span> dwExtraInfo);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> KEYEVENTF_KEYUP = 0x02;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> KEYEVENTF_KEYDOWN = 0x00;</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">bool</span> running = <span style="color: blue;">true</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">void</span> CloseBroadcomWindowWorker()</pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">while</span> (running)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> hwnd = FindWindow(<span style="color: #a31515;">&quot;Broadcom_BTWizard&quot;</span>, <span style="color: #a31515;">&quot;Bluetooth&quot;</span>);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (hwnd != <span style="color: #2b91af;">IntPtr</span>.Zero)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; keybd_event((<span style="color: blue;">byte</span>)<span style="color: #2b91af;">Keys</span>.F1, 0, KEYEVENTF_KEYDOWN, 0);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; keybd_event((<span style="color: blue;">byte</span>)<span style="color: #2b91af;">Keys</span>.F1, 0, KEYEVENTF_KEYUP, 0);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Thread</span>.Sleep(5000);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br /><br />This is of course not the best solution but if you have a similar problem then this might save you some time if your only requirement is to get it to work as soon as possible. Otherwise, I would suggest avoiding the Widcomm Bluetooth Stack and just go for devices that use the Microsoft Bluetooth Stack