---
layout: post
title: Copying files from the Desktop to the Device using .NET
date: '2010-08-23T12:18:00.014+02:00'
author: Christian Resma Helle
tags:
- RAPI
modified_time: '2010-08-23T15:11:56.583+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-6097183768724829755
blogger_orig_url: https://christian-helle.blogspot.com/2010/08/copying-files-from-desktop-to-device.html
---

Someone asked me recently how to copy files from the desktop to the device after reading my old article called <a href="http://christian-helle.blogspot.com/2007/06/copying-files-from-device-to-desktop.html">How to copy files from the Device to the Desktop using .NET</a>. Well here's how to do it:<br /><br />First, we'll need our P/Invokes to <span style="font-weight:bold;">rapi.dll</span><br /><br /><div style="font-family: Courier New; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeRapiInit();</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeRapiUninit();</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: #2b91af;">IntPtr</span> CeCreateFile(</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">string</span> lpFileName,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">uint</span> dwDesiredAccess,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">int</span> dwShareMode,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">int</span> lpSecurityAttributes,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">int</span> dwCreationDisposition,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">int</span> dwFlagsAndAttributes,</pre><pre style="margin: 0px;">&nbsp; <span style="color: blue;">int</span> hTemplateFile);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">internal</span> <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeWriteFile(</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">IntPtr</span> hFile,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">byte</span>[] lpBuffer,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> nNumberOfbytesToWrite,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">ref</span> <span style="color: blue;">int</span> lpNumberOfbytesWritten,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> lpOverlapped);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">internal</span> <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeSetFileTime(</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">IntPtr</span> hFile,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">ref</span> <span style="color: blue;">long</span> lpCreationTime,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">ref</span> <span style="color: blue;">long</span> lpLastAccessTime,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">ref</span> <span style="color: blue;">long</span> lpLastWriteTime);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> BUFFER_SIZE = 1024 * 5; <span style="color: green;">// 5k transfer buffer</span></pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> CREATE_ALWAYS = 2;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> ERROR_SUCCESS = 0;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> FILE_ATTRIBUTE_NORMAL = 0x80;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">uint</span> GENERIC_WRITE = 0x40000000;</pre><pre style="margin: 0px;"><span style="color: blue;">const</span> <span style="color: blue;">int</span> INVALID_HANDLE_VALUE = -1;</pre></div><br /><br />Now let's wrap all those in a method called CopyToDevice(string localFile, string remoteFile). The localFile is the file located on the desktop and the remoteFile is the destination filename on the device.<br /><br /><div style="font-family: Courier New; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">void</span> CopyToDevice(<span style="color: blue;">string</span> localFile, <span style="color: blue;">string</span> remoteFile)</pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> rapi = CeRapiInit() == ERROR_SUCCESS;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!rapi)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">try</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> filePtr = CeCreateFile(remoteFile, GENERIC_WRITE, 0, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (filePtr == <span style="color: blue;">new</span> <span style="color: #2b91af;">IntPtr</span>(INVALID_HANDLE_VALUE))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (<span style="color: blue;">var</span> localFileStream = <span style="color: blue;">new</span> <span style="color: #2b91af;">FileStream</span>(localFile, <span style="color: #2b91af;">FileMode</span>.Open, <span style="color: #2b91af;">FileAccess</span>.Read))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> byteswritten = 0;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> position = 0;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> buffer = <span style="color: blue;">new</span> <span style="color: blue;">byte</span>[BUFFER_SIZE];</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> bytesread = localFileStream.Read(buffer, position, BUFFER_SIZE);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">while</span> (bytesread &gt; 0)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; position += bytesread;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (CeWriteFile(filePtr, buffer, bytesread, <span style="color: blue;">ref</span> byteswritten, 0) == ERROR_SUCCESS)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">try</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bytesread = localFileStream.Read(buffer, 0, BUFFER_SIZE);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">catch</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; bytesread = 0;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">finally</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CeRapiUninit();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br /><br />To use the code above you will have to know the full path of the file on the desktop. <br />I hope you found this useful.