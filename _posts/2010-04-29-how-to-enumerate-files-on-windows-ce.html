---
layout: post
title: How to enumerate files on a Windows CE based device from the Desktop
date: '2010-04-29T13:02:00.032+02:00'
# author: Christian Resma Helle
tags:
- RAPI
- How to
- ".NET Compact Framework"
modified_time: '2010-04-29T19:32:31.886+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-5976418551323130243
blogger_orig_url: https://christian-helle.blogspot.com/2010/04/how-to-enumerate-files-on-windows-ce.html
---

In this article I'd like to demonstrate how to enumerate files on a Windows CE based device from the desktop. <br /><br />Listing the contents of a directly on a Windows CE from the desktop is something I found to be useful every now and then. It involves using the <a href="http://msdn.microsoft.com/en-us/library/aa920177.aspx">Remote API</a> and ActiveSync / Windows Mobile Device Center<br /><br />As usual this will involve a few P/Invokes:<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeRapiInit();</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> CeRapiUninit();</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: #2b91af;">IntPtr</span> CeFindFirstFile(<span style="color: blue;">string</span> lpFileName, <span style="color: blue;">ref</span> <span style="color: #2b91af;">CE_FIND_DATA</span> lpFindFileData);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">bool</span> CeFindNextFile(<span style="color: #2b91af;">IntPtr</span> hFindFile, <span style="color: blue;">ref</span> <span style="color: #2b91af;">CE_FIND_DATA</span> lpFindFileData);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;rapi.dll&quot;</span>, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">bool</span> CeFindClose(<span style="color: #2b91af;">IntPtr</span> hFindFile);</pre></div><br /><br />We also need the <a href="http://msdn.microsoft.com/en-us/library/aa917196.aspx">CE_FIND_DATA</a> structure<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">[<span style="color: #2b91af;">StructLayout</span>(<span style="color: #2b91af;">LayoutKind</span>.Sequential, CharSet = <span style="color: #2b91af;">CharSet</span>.Unicode)]</pre><pre style="margin: 0px;"><span style="color: blue;">struct</span> <span style="color: #2b91af;">CE_FIND_DATA</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwFileAttributes;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">FILETIME</span> ftCreationTime;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">FILETIME</span> ftLastAccessTime;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">FILETIME</span> ftLastWriteTime;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> nFileSizeHigh;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> nFileSizeLow;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwOID;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">MarshalAs</span>(<span style="color: #2b91af;">UnmanagedType</span>.ByValTStr, SizeConst = 260)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">string</span> cFileName;</pre><pre style="margin: 0px;">};</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">[<span style="color: #2b91af;">StructLayout</span>(<span style="color: #2b91af;">LayoutKind</span>.Sequential)]</pre><pre style="margin: 0px;"><span style="color: blue;">struct</span> <span style="color: #2b91af;">FILETIME</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwLowDateTime;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwHighDateTime;</pre><pre style="margin: 0px;">}</pre></div><br /><br />The <a href="http://msdn.microsoft.com/en-us/library/aa922061.aspx">CeRapiInit</a> method has be always called before performing Remote API operations. Once done, the <a href="http://msdn.microsoft.com/en-us/library/aa918093.aspx">CeRapiUninit</a> must be called. For listing the files in a directory, I use <a href="http://msdn.microsoft.com/en-us/library/aa917424.aspx">CeFindFirstFile</a>, <a href="http://msdn.microsoft.com/en-us/library/aa918923.aspx">CeFindNextFile</a>, and <a href="http://msdn.microsoft.com/en-us/library/aa917593.aspx">CeFindClose</a>. How this works: If the file(s) exists CeFindFirstFile will return a valid handle that can be used for calling CeFindNextFile. After going through all the files CeFindNextFile will return false and a call to CeFindClose needs to be called.<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: blue;">string</span>[] GetFiles(<span style="color: blue;">string</span> remoteDirectory)</pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">try</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CeRapiInit();</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> list = <span style="color: blue;">new</span> <span style="color: #2b91af;">List</span>&lt;<span style="color: blue;">string</span>&gt;();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> findData = <span style="color: blue;">new</span> <span style="color: #2b91af;">CE_FIND_DATA</span>();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> hFindFile = CeFindFirstFile(remoteDirectory + <span style="color: #a31515;">&quot;\\*&quot;</span>, <span style="color: blue;">ref</span> findData);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (hFindFile != <span style="color: blue;">new</span> <span style="color: #2b91af;">IntPtr</span>(-1))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">try</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">do</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (findData.dwFileAttributes != (<span style="color: blue;">int</span>)<span style="color: #2b91af;">FileAttributes</span>.Directory)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; list.Add(findData.cFileName);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } <span style="color: blue;">while</span> (CeFindNextFile(hFindFile, <span style="color: blue;">ref</span> findData));</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">finally</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CeFindClose(hFindFile);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> list.ToArray();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">finally</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CeRapiUninit();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">}</pre></div><br /><br />I hope you found this useful.