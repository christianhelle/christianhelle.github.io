---
layout: post
title: ListView Custom Drawing in .NETCF
date: '2009-10-08T00:41:00.006+02:00'
author: Christian Resma Helle
tags:
- Controls
- ListView
- Windows Mobile
- ".NET Compact Framework"
modified_time: '2010-06-22T15:04:46.553+02:00'
blogger_id: tag:blogger.com,1999:blog-4995334164049002857.post-3730277627073804775
blogger_orig_url: https://christian-helle.blogspot.com/2009/10/listview-custom-drawing-in-netcf.html
---

In this article I would like to demonstrate how to do custom drawing in the ListView control that the .NET Compact Framework provides. I'll be extending the code I published last year in the article entitled <a href="/2008/10/listview-extended-styles-in-netcf.html">ListView Extended Styles in .NETCF</a><br /><br />This is normally a very tedious and frustrating task to do and to accomplish this task we'll have to take advantage of the custom drawing service Windows CE provides for certain controls. A very good reference for custom drawing is an MSDN article called <a href="http://msdn.microsoft.com/en-us/library/bb761817(VS.85).aspx">Customizing a Control's Appearance using Custom Draw</a>. Before going any further, I may have to warn you about the extensive interop code involved in this task.<br /><br />We'll have to handle the ListView windows messages ourselves, and we accomplish this by subclassing this ListView. <a href="http://msdn.microsoft.com/en-us/library/ms633570(VS.85).aspx#subclassing_window">Subclassing a window</a> means that we assign a new window procedure for messages that are meant for the ListView. This can be done through the <a href="http://msdn.microsoft.com/en-us/library/ms633591(VS.85).aspx">SetWindowLong()</a> method with the GWL_WNDPROC parameter. When subclassing, the developer is responsible for choosing which messages they want to handle, which to ignore, and which they let operating system handle. To have the operating system handle the message, a call to <a href="http://msdn.microsoft.com/en-us/library/ms633571(VS.85).aspx">CallWindowProc</a>() is done using a pointer to original window procedure.<br /><br />Before setting the new window procedure its important to get a pointer to the original one in case the developer wishes to let the operating system handle the message. This is done through <a href="http://msdn.microsoft.com/en-us/library/ms633584(VS.85).aspx">GetWindowLong</a>()<br /><br />Let's get started...<br /><br /><br />First we need to define the interop structures for custom drawing<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> <span style="color: #2b91af;">RECT</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> left;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> top;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> right;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> bottom;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> <span style="color: #2b91af;">NMHDR</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> hwndFrom;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> idFrom;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> code;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> <span style="color: #2b91af;">NMCUSTOMDRAW</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">NMHDR</span> nmcd;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwDrawStage;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> hdc;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">RECT</span> rc;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwItemSpec;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> uItemState;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">IntPtr</span> lItemlParam;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">struct</span> <span style="color: #2b91af;">NMLVCUSTOMDRAW</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">NMCUSTOMDRAW</span> nmcd;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> clrText;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> clrTextBk;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> iSubItem;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> dwItemType;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> clrFace;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> iIconEffect;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> iIconPhase;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> iPartId;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">int</span> iStateId;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: #2b91af;">RECT</span> rcText;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">uint</span> uAlign;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre></div><br />Note: In C# (and VB and C++), the <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.structlayoutattribute.aspx">StructLayout</a> is Sequencial by default, hence I didn't state it<br /><br /><br />The P/Invoke declarations we need are the following:<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: #2b91af;">IntPtr</span> CallWindowProc(<span style="color: #2b91af;">IntPtr</span> lpPrevWndFunc, <span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">uint</span> Msg, <span style="color: #2b91af;">IntPtr</span> wParam, <span style="color: #2b91af;">IntPtr</span> lParam);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll&quot;</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> SendMessage(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">int</span> Msg, <span style="color: blue;">int</span> wParam, <span style="color: blue;">ref</span> <span style="color: #2b91af;">RECT</span> lParam);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">uint</span> SendMessage(<span style="color: #2b91af;">IntPtr</span> hwnd, <span style="color: blue;">uint</span> msg, <span style="color: blue;">uint</span> wparam, <span style="color: blue;">uint</span> lparam);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>, SetLastError = <span style="color: blue;">true</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: blue;">int</span> SetWindowLong(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">int</span> nIndex, <span style="color: #2b91af;">WndProcDelegate</span> newProc);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; [<span style="color: #2b91af;">DllImport</span>(<span style="color: #a31515;">&quot;coredll.dll&quot;</span>, SetLastError = <span style="color: blue;">true</span>)]</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">extern</span> <span style="color: #2b91af;">IntPtr</span> GetWindowLong(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">int</span> nIndex);</pre></div><br /><br />And to make life a bit easier, I created some extension methods to the RECT struct we just defined.<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">class</span> <span style="color: #2b91af;">RectangleExtensions</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: #2b91af;">Rectangle</span> ToRectangle(<span style="color: blue;">this</span> <span style="color: #2b91af;">RECT</span> rectangle)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: #2b91af;">Rectangle</span>.FromLTRB(rectangle.left, rectangle.top, rectangle.right, rectangle.bottom);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">static</span> <span style="color: #2b91af;">RectangleF</span> ToRectangleF(<span style="color: blue;">this</span> <span style="color: #2b91af;">RECT</span> rectangle)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: blue;">new</span> <span style="color: #2b91af;">RectangleF</span>(rectangle.left, rectangle.top, rectangle.right, rectangle.bottom);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre></div><br /><br />We'll need the following constants defined in the windows platform SDK<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> GWL_WNDPROC = -4;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> WM_NOTIFY = 0x4E;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> NM_CUSTOMDRAW = (-12);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDRF_NOTIFYITEMDRAW = 0x00000020;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDRF_NOTIFYSUBITEMDRAW = CDRF_NOTIFYITEMDRAW;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDRF_NOTIFYPOSTPAINT = 0x00000010;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDRF_SKIPDEFAULT = 0x00000004;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDRF_DODEFAULT = 0x00000000;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDDS_PREPAINT = 0x00000001;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDDS_POSTPAINT = 0x00000002;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDDS_ITEM = 0x00010000;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDDS_ITEMPREPAINT = (CDDS_ITEM | CDDS_PREPAINT);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDDS_SUBITEM = 0x00020000;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> CDIS_SELECTED = 0x0001;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">const</span> <span style="color: blue;">int</span> LVM_GETSUBITEMRECT = (0x1000 + 56);</pre></div><br /><br />Custom drawing in the ListView will only work in the Details view mode. To ensure this, I set the View to View.Details in the constructor method. Since I'm extending my old ListViewEx (Enables ListView Extended Styles) I'm gonna enable Double buffering, Grid lines, and the Gradient background. I'm gonna enable subclassing on the ListView only when the parent is changed, this is because I need to receive messages sent to the parent control of the ListView. We also need a delegate for the new window procedure and a pointer to the original window procedure. And last but not the least we need the actual window procedure method.<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">delegate</span> <span style="color: #2b91af;">IntPtr</span> <span style="color: #2b91af;">WndProcDelegate</span>(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">uint</span> msg, <span style="color: #2b91af;">IntPtr</span> wParam, <span style="color: #2b91af;">IntPtr</span> lParam);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">IntPtr</span> lpPrevWndFunc;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> ListViewCustomDraw()</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; View = <span style="color: #2b91af;">View</span>.Details;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DoubleBuffering = <span style="color: blue;">true</span>;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; GridLines = <span style="color: blue;">true</span>;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Gradient = <span style="color: blue;">true</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ParentChanged += <span style="color: blue;">delegate</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lpPrevWndFunc = GetWindowLong(Parent.Handle, GWL_WNDPROC);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SetWindowLong(Parent.Handle, GWL_WNDPROC, WndProc);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; };</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">private</span> <span style="color: #2b91af;">IntPtr</span> WndProc(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">uint</span> msg, <span style="color: #2b91af;">IntPtr</span> wParam, <span style="color: #2b91af;">IntPtr</span> lParam)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (msg == WM_NOTIFY)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> nmhdr = (<span style="color: #2b91af;">NMHDR</span>)<span style="color: #2b91af;">Marshal</span>.PtrToStructure(lParam, <span style="color: blue;">typeof</span>(<span style="color: #2b91af;">NMHDR</span>));</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (nmhdr.hwndFrom == Handle &amp;&amp; nmhdr.code == NM_CUSTOMDRAW)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> CustomDraw(hWnd, msg, wParam, lParam);</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> CallWindowProc(lpPrevWndFunc, hWnd, msg, wParam, lParam);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre></div><br />In the new window procedure, we are only really interested in the WM_NOTIFY message, because this is what the <a href="http://msdn.microsoft.com/en-us/library/bb774865(VS.85).aspx">NM_CUSTOMDRAW</a> message is sent through. The LPARAM parameter of the message will contain the NMHDR which then contains the NM_CUSTOMDRAW message. The LPARAM also contains the <a href="http://msdn.microsoft.com/en-us/library/bb774778(VS.85).aspx">NMLVCUSTOMDRAW</a> which provide state and information about the ListView.<br /><br />The trickiest part in performing custom drawing in the ListView is handling the drawing stage. We create a method called CustomDraw to handle the different drawing stages of the ListView<br /><br /><div style="font-family: Fixedsys; font-size: 10pt; color: black; background: white;"><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">private</span> <span style="color: #2b91af;">IntPtr</span> CustomDraw(<span style="color: #2b91af;">IntPtr</span> hWnd, <span style="color: blue;">uint</span> msg, <span style="color: #2b91af;">IntPtr</span> wParam, <span style="color: #2b91af;">IntPtr</span> lParam)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">int</span> result;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> nmlvcd = (<span style="color: #2b91af;">NMLVCUSTOMDRAW</span>)<span style="color: #2b91af;">Marshal</span>.PtrToStructure(lParam, <span style="color: blue;">typeof</span>(<span style="color: #2b91af;">NMLVCUSTOMDRAW</span>));</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">switch</span> (nmlvcd.nmcd.dwDrawStage)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> CDDS_PREPAINT:</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; result = CDRF_NOTIFYITEMDRAW;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> CDDS_ITEMPREPAINT:</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> itemBounds = nmlvcd.nmcd.rc.ToRectangle();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((nmlvcd.nmcd.uItemState &amp; CDIS_SELECTED) != 0)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (<span style="color: blue;">var</span> brush = <span style="color: blue;">new</span> <span style="color: #2b91af;">SolidBrush</span>(<span style="color: #2b91af;">SystemColors</span>.Highlight))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (<span style="color: blue;">var</span> graphics = <span style="color: #2b91af;">Graphics</span>.FromHdc(nmlvcd.nmcd.hdc))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; graphics.FillRectangle(brush, itemBounds);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; result = CDRF_NOTIFYSUBITEMDRAW;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">case</span> CDDS_SUBITEM | CDDS_ITEMPREPAINT:</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> index = nmlvcd.nmcd.dwItemSpec;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> rect = <span style="color: blue;">new</span> <span style="color: #2b91af;">RECT</span>();</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; rect.top = nmlvcd.iSubItem;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SendMessage(Handle, LVM_GETSUBITEMRECT, index, <span style="color: blue;">ref</span> rect);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; rect.left += 2;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Color</span> textColor;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> ((nmlvcd.nmcd.uItemState &amp; CDIS_SELECTED) != 0)</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; textColor = <span style="color: #2b91af;">SystemColors</span>.HighlightText;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">else</span></pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; textColor = <span style="color: #2b91af;">SystemColors</span>.ControlText;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (<span style="color: blue;">var</span> brush = <span style="color: blue;">new</span> <span style="color: #2b91af;">SolidBrush</span>(textColor))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (<span style="color: blue;">var</span> graphics = <span style="color: #2b91af;">Graphics</span>.FromHdc(nmlvcd.nmcd.hdc))</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; graphics.DrawString(Items[index].SubItems[nmlvcd.iSubItem].Text,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Font,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; brush,</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; rect.ToRectangleF());</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; result = CDRF_SKIPDEFAULT | CDRF_NOTIFYSUBITEMDRAW;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">default</span>:</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; result = CDRF_DODEFAULT;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">break</span>;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</pre><pre style="margin: 0px;">&nbsp;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> (<span style="color: #2b91af;">IntPtr</span>)result;</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</pre></div><br />In the first stage we handle is the CDDS_PREPAINT. Here we return CDRF_NOTIFYITEMDRAW to tell that we want to handle drawing of the row ourselves. After this we receive the CDDS_ITEMPREPAINT where we can draw the entire row. <br /><br />We check if the row is selected through the uItemState field of NMCUSTOMDRAW, if this field has the CDIS_SELECTED flag then it means the item is selected, hence we draw a fill rectangle. After handling the CDDS_ITEMPREPAINT, we return CDRF_NOTIFYSUBITEMDRAW to tell that we want to draw the sub items ourselves.<br /><br />For drawing the sub items we need to handle CDDS_SUBITEM | CDDS_ITEMPREPAINT. We can get the position index of the item through the dwItemSpec field of NMCUSTOMDRAW. To get the bounds of the current sub item we send the <a href="http://msdn.microsoft.com/en-us/library/bb761075(VS.85).aspx">LVM_GETSUBITEMRECT</a> message to the ListView and pass a pointer to <a href="http://msdn.microsoft.com/en-us/library/dd162897(VS.85).aspx">RECT</a> as the LPARAM. Before sending this message, set the "top" field of the RECT to the index of the sub item (retrieved from iSubItem field of NMLVCUSTOMDRAW. After drawing the sub item we return CDRF_SKIPDEFAULT | CDRF_NOTIFYSUBITEMDRAW to tell that we only care about handling the next sub item.<br /><br />Well I hope you guys find this interesting and helpful. To keep things simple, I only demonstrated displaying plan text and a plain rectangle for the selection. <br /><br />If you're interested in the full source code then you can grab it <a href="http://cid-ca531e7fb4762c70.skydrive.live.com/self.aspx/Code%20Samples/ListViewCustomDrawing.zip">here</a>.